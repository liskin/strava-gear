import csv
from os import PathLike
import sqlite3
from typing import Dict
from typing import List
from typing import TextIO
from typing import Union

from ..data import BikeId
from ..data import BikeName
from ..data import Input
from .date import parse_datetime

essential_columns = {
    'name',
    'gear_id',
    'start_date',
    'moving_time',
    'distance',
    'total_elevation_gain',
}


def read_input_csv(inp: TextIO) -> Input:
    """
    Load activities from CSV generated from this command:

        sqlite3 ~/.local/share/strava_offline/strava.sqlite \
            ".mode csv" \
            ".headers on" \
            "SELECT name, gear_id, start_date, moving_time, distance, total_elevation_gain FROM activity" \
            >activities.csv
    """
    activities: List[Dict] = []
    for r in csv.DictReader(inp):
        assert essential_columns <= r.keys()
        activities.append({
            **r,
            'moving_time': int(r['moving_time']),
            'distance': float(r['distance']),
            'total_elevation_gain': float(r['total_elevation_gain']),
            'start_date': parse_datetime(r['start_date']),
        })

    return Input(activities=activities)


def read_strava_offline(db_filename: Union[str, PathLike]) -> Input:
    """
    Load activities from strava-offline database.
    """
    with sqlite3.connect(db_filename) as db:
        db.row_factory = sqlite3.Row

        aliases = {
            BikeName(r['name']): BikeId(r['id'])
            for r in db.execute('SELECT name, id FROM bike')
        }

        activities: List[Dict] = []
        for r in db.execute('SELECT * FROM activity'):
            assert essential_columns <= set(r.keys())
            activities.append({**r, 'start_date': parse_datetime(r['start_date'])})

        return Input(
            activities=activities,
            aliases=aliases,
            bike_retired=bike_retired
        )
